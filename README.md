# ë°°ë‹¬ì˜ ë¯¼ì¡± : ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ë¶„ì„/ì„¤ê³„ ë° êµ¬í˜„ ì‹¤ìŠµ

ì°¸ê³  í…œí”Œë¦¿: https://github.com/msa-ez/example-food-delivery



# ì„œë¹„ìŠ¤ ì‹œë‚˜ë¦¬ì˜¤

ê¸°ëŠ¥ì  ìš”êµ¬ì‚¬í•­
1. ê³ ê°ì´ ë©”ë‰´ë¥¼ ì„ íƒí•˜ì—¬ ì£¼ë¬¸í•œë‹¤
1. ê³ ê°ì´ ì„ íƒí•œ ë©”ë‰´ì— ëŒ€í•´ ê²°ì œí•œë‹¤.
1. ì£¼ë¬¸ì´ ë˜ë©´ ì£¼ë¬¸ ë‚´ì—­ì´ ì…ì ìƒì ì£¼ì¸ì—ê²Œ ì£¼ë¬¸ì •ë³´ê°€ ì „ë‹¬ëœë‹¤.
1. ìƒì ì£¼ëŠ” ì£¼ë¬¸ì„ ìˆ˜ë½í•˜ê±°ë‚˜ ê±°ì ˆí•  ìˆ˜ ìˆë‹¤.
1. ìƒì ì£¼ëŠ” ìš”ë¦¬ì‹œì‘ ë•Œì™€ ì™„ë£Œ ì‹œì ì— ì‹œìŠ¤í…œì— ìƒíƒœë¥¼ ì…ë ¥í•œë‹¤.
1. ê³ ê°ì€ ì•„ì§ ìš”ë¦¬ê°€ ì‹œì‘ë˜ì§€ ì•Šì€ ì£¼ë¬¸ì€ ì·¨ì†Œí•  ìˆ˜ ìˆë‹¤.
1. ìš”ë¦¬ê°€ ì™„ë£Œë˜ë©´ ê³ ê°ì˜ ì§€ì—­ ì¸ê·¼ì˜ ë¼ì´ë”ë“¤ì— ì˜í•´ ë°°ì†¡ê±´ ì¡°íšŒê°€ ê°€ëŠ¥í•˜ë‹¤.
1. ë¼ì´ë”ê°€ í•´ë‹¹ ìš”ë¦¬ë¥¼ Pickí•œ í›„, ì•±ì„ í†µí•´ í†µë³´í•œë‹¤.
1. ê³ ê°ì´ ì£¼ë¬¸ìƒíƒœë¥¼ ì¤‘ê°„ì¤‘ê°„ ì¡°íšŒí•œë‹¤.
1. ì£¼ë¬¸ìƒíƒœê°€ ë°”ë€” ë•Œ ë§ˆë‹¤ ì¹´í†¡ìœ¼ë¡œ ì•Œë¦¼ì„ ë³´ë‚¸ë‹¤.
1. ê³ ê°ì´ ìš”ë¦¬ë¥¼ ë°°ë‹¬ ë°›ìœ¼ë©´ ë°°ì†¡í™•ì¸ ë²„íŠ¼ì„ íƒ­í•˜ì—¬, ëª¨ë“  ê±°ë˜ê°€ ì™„ë£Œëœë‹¤.


ë¹„ê¸°ëŠ¥ì  ìš”êµ¬ì‚¬í•­
1. íŠ¸ëœì­ì…˜
    1. ê²°ì œê°€ ë˜ì§€ ì•Šì€ ì£¼ë¬¸ê±´ì€ ì•„ì˜ˆ ê±°ë˜ê°€ ì„±ë¦½ë˜ì§€ ì•Šì•„ì•¼ í•œë‹¤  Sync í˜¸ì¶œ 
1. ì¥ì• ê²©ë¦¬
    1. ìƒì ê´€ë¦¬ ê¸°ëŠ¥ì´ ìˆ˜í–‰ë˜ì§€ ì•Šë”ë¼ë„ ì£¼ë¬¸ì€ 365ì¼ 24ì‹œê°„ ë°›ì„ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤  Async (event-driven), Eventual Consistency
    1. ê²°ì œì‹œìŠ¤í…œì´ ê³¼ì¤‘ë˜ë©´ ì‚¬ìš©ìë¥¼ ì ì‹œë™ì•ˆ ë°›ì§€ ì•Šê³  ê²°ì œë¥¼ ì ì‹œí›„ì— í•˜ë„ë¡ ìœ ë„í•œë‹¤  Circuit breaker, fallback
1. ì„±ëŠ¥
    1. ê³ ê°ì´ ìì£¼ ìƒì ê´€ë¦¬ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆëŠ” ë°°ë‹¬ìƒíƒœë¥¼ ì£¼ë¬¸ì‹œìŠ¤í…œ(í”„ë¡ íŠ¸ì—”ë“œ)ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ì•¼ í•œë‹¤  CQRS
    1. ë°°ë‹¬ìƒíƒœê°€ ë°”ë€”ë•Œë§ˆë‹¤ ì¹´í†¡ ë“±ìœ¼ë¡œ ì•Œë¦¼ì„ ì¤„ ìˆ˜ ìˆì–´ì•¼ í•œë‹¤  Event driven


# ğŸˆ ì²´í¬í¬ì¸íŠ¸

[ë¶„ì„/ì„¤ê³„: ì´ë²¤íŠ¸ ìŠ¤í† ë°](#-ë¶„ì„ì„¤ê³„-ì´ë²¤íŠ¸-ìŠ¤í† ë°)

[ìƒˆë¡­ê²Œ ì¶”ê°€í•œ ê¸°ëŠ¥ 2ê°€ì§€](#-ìƒˆë¡­ê²Œ-ì¶”ê°€í•œ-ê¸°ëŠ¥-2ê°€ì§€)

[ì²´í¬í¬ì¸íŠ¸1. Saga (Pub / Sub)](#-ì²´í¬í¬ì¸íŠ¸1-saga-pub--sub)

[ì²´í¬í¬ì¸íŠ¸2. CQRS](#-ì²´í¬í¬ì¸íŠ¸2-cqrs)

[ì²´í¬í¬ì¸íŠ¸3. Compensation / Correlation](#-ì²´í¬í¬ì¸íŠ¸3-compensation--correlation)

[ì²´í¬í¬ì¸íŠ¸4. Request / Response](#-ì²´í¬í¬ì¸íŠ¸4-request--response)

[ì²´í¬í¬ì¸íŠ¸5. Circuit Breaker](#-ì²´í¬í¬ì¸íŠ¸5-circuit-breaker)

[ì²´í¬í¬ì¸íŠ¸6. Gateway / Ingress](#-ì²´í¬í¬ì¸íŠ¸6-gateway--ingress)





## ğŸˆ ë¶„ì„/ì„¤ê³„: ì´ë²¤íŠ¸ ìŠ¤í† ë°

![image](https://user-images.githubusercontent.com/70236767/205795328-411fbf9c-0ac4-4f04-8425-96670b4396f9.png)


ì‚¬ì§„ íŒŒì¼ [ë§í¬](./myModeling.png)


## ğŸˆ ìƒˆë¡­ê²Œ ì¶”ê°€í•œ ê¸°ëŠ¥ 2ê°€ì§€

ìƒˆë¡­ê²Œ ì¶”ê°€í•œ ê¸°ëŠ¥ìœ¼ë¡œ ì¿ í° ê¸°ëŠ¥(ì¿ í°ìƒì„±/ì¿ í°ì‚¬ìš©)ê³¼ ì£¼ë¬¸ ì˜µì…˜ ìˆ˜ì • ê¸°ëŠ¥ì´ ìˆë‹¤.

### 1. ì¿ í°

![image](https://user-images.githubusercontent.com/70236767/205791378-37b8e704-1cac-4f66-ba96-079deb98e552.png)

#### ì¿ í°ìƒì„±

ë°°ë‹¬ì´ ì™„ë£Œë˜ë©´ rider ì„œë¹„ìŠ¤ì—ì„œ Delivered ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ì„œ publish í•œë‹¤. ì´ ë•Œ coupon ì„œë¹„ìŠ¤ì—ì„œ createCoupon ì •ì±…ì— ì˜í•´ CouponCreated ì´ë²¤íŠ¸ê°€ ë°œìƒë˜ë©´ì„œ ì¿ í°ì´ ìƒì„±ëœë‹¤.


#### ì¿ í°ì‚¬ìš©

ê³ ê°ì´ use ì»¤ë§¨ë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì¿ í°ì„ ì‚¬ìš©í•˜ë©´ CouponUsed ì´ë²¤íŠ¸ê°€ ë°œìƒí•œë‹¤. ê·¸ë¦¬ê³  Req/Res ë°©ì‹ìœ¼ë¡œ ordering ì„œë¹„ìŠ¤ì˜ updateCoupon ì»¤ë§¨ë“œë¥¼ í˜¸ì¶œí•˜ì—¬ OrderUpdated ì´ë²¤íŠ¸ê°€ ë°œìƒë˜ë©´ì„œ ì£¼ë¬¸ì— ì¿ í°ì´ ì ìš©ëœë‹¤.



### 2. ì£¼ë¬¸ ì˜µì…˜ ìˆ˜ì •

![image](https://user-images.githubusercontent.com/70236767/205794609-190d16b0-814f-4339-afb5-048c0fcbf19f.png)

ê³ ê°ì´ updateCoupon ì»¤ë§¨ë“œë¥¼ í˜¸ì¶œí•˜ì—¬ ì£¼ë¬¸ ì˜µì…˜ì„ ìˆ˜ì •í•˜ë©´ OrderUpdated ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ë©´ì„œ publishí•œë‹¤. ì´ ë•Œ updateOrder ì •ì±…ì— ì˜í•´ orderUpdated ì´ë²¤íŠ¸ê°€ ë°œìƒë˜ë©´ì„œ ì£¼ë¬¸ ì˜µì…˜ì´ ìˆ˜ì •ëœë‹¤.



## ğŸˆ ì²´í¬í¬ì¸íŠ¸1 Saga (Pub / Sub)

### Publish

ê²°ì œê°€ ì´ë£¨ì–´ì¡Œì„ ë•Œ Paymentì˜ @PostPersist ì–´ë…¸í…Œì´ì…˜ì´ ì„¤ì •ë˜ì–´ìˆëŠ” onPostPersist()ì— ì˜í•´ paidê°€ publishëœë‹¤.

ordering ì„œë¹„ìŠ¤ í”„ë¡œì íŠ¸: Payment.java

```java
    /**
        ê²°ì œê°€ ì´ë£¨ì–´ì§„ ì§í›„ í˜¸ì¶œ (PostPersist)
     */
    @PostPersist
    public void onPostPersist(){
        // Paidë¥¼ publishí•œë‹¤.
        Paid paid = new Paid(this);
        paid.publishAfterCommit();

    }
```

### Subscribe

store ì„œë¹„ìŠ¤ í”„ë¡œì íŠ¸: PolicyHandler.java

```java
    /**
        ê²°ì œê°€ ë˜ì—ˆì„ ë•Œ (Paid ì´ë²¤íŠ¸) ìƒíƒœë¥¼ ë³€ê²½í•œë‹¤.
     */
    @StreamListener(value=KafkaProcessor.INPUT, condition="headers['type']=='Paid'")
    public void wheneverPaid_UpdateStatus(@Payload Paid paid){
        Paid event = paid;
        System.out.println("\n\n##### listener UpdateStatus : " + paid + "\n\n");

        // Sample Logic //
        // FoodCookingì˜ ìƒíƒœë³€ê²½í•˜ê¸° (ê²°ì œ ì™„ë£Œ ìƒíƒœ)
        FoodCooking.updateStatus(event);
    }
```


## ğŸˆ ì²´í¬í¬ì¸íŠ¸2 CQRS

CQRSë¥¼ í†µí•´ ì£¼ë¬¸ ìƒíƒœê°€ ë³€ê²½ë˜ëŠ” ì´ë²¤íŠ¸ê°€ ë°œìƒí•  ë•Œë§ˆë‹¤ viewì˜ ì£¼ë¬¸ ìƒíƒœë¥¼ ë³€ê²½í•˜ë„ë¡ í•œë‹¤.


![image](https://user-images.githubusercontent.com/70236767/205803959-2ec262fc-cfe7-40b2-9235-2bd5f4fbc958.png)


![image](https://user-images.githubusercontent.com/70236767/205804108-3a583d28-2411-458a-a05a-93608e4daf38.png)


![image](https://user-images.githubusercontent.com/70236767/205804057-faa0e31b-fe40-41a5-b0e9-8419e432d272.png)

![image](https://user-images.githubusercontent.com/70236767/205804142-c40b2aa8-f5c0-422c-9bee-44a0c9c2f301.png)

![image](https://user-images.githubusercontent.com/70236767/205804302-6ba3641f-9cf9-414c-aed9-50313efec5cb.png)

![image](https://user-images.githubusercontent.com/70236767/205804329-9488a15e-7da1-4f82-8808-dabf9eabde62.png)


```java
@Service
public class MypageViewHandler {

    @Autowired
    private MypageRepository mypageRepository;


    /**
        ì£¼ë¬¸ì´ ë“¤ì–´ì™”ì„ ë•Œ
     */
    @StreamListener(KafkaProcessor.INPUT)
    public void whenOrderPlaced_then_CREATE_1 (@Payload OrderPlaced orderPlaced) {
        try {

            if (!orderPlaced.validate()) return;

            // view ê°ì²´ ìƒì„±
            Mypage mypage = new Mypage();
            // view ê°ì²´ì— ì´ë²¤íŠ¸ì˜ Value ë¥¼ set í•¨
            mypage.setStatus("ordered");
            // view ë ˆíŒŒì§€ í† ë¦¬ì— save
            mypageRepository.save(mypage);

        }catch (Exception e){
            e.printStackTrace();
        }
    }

    /**
        ê²°ì œê°€ ë˜ì—ˆì„ ë•Œ
     */
    @StreamListener(KafkaProcessor.INPUT)
    public void whenPaid_then_UPDATE_1(@Payload Paid paid) {
        try {
            if (!paid.validate()) return;
                // view ê°ì²´ ì¡°íšŒ
            Optional<Mypage> mypageOptional = mypageRepository.findById(Long.valueOf(paid.getOrderId()));

            if( mypageOptional.isPresent()) {
                 Mypage mypage = mypageOptional.get();
            // view ê°ì²´ì— ì´ë²¤íŠ¸ì˜ eventDirectValue ë¥¼ set í•¨
                mypage.setStatus("paid");    
                // view ë ˆíŒŒì§€ í† ë¦¬ì— save
                 mypageRepository.save(mypage);
                }


        }catch (Exception e){
            e.printStackTrace();
        }
    }

    /**
        ì£¼ë¬¸ì´ ë°›ì•„ë“¤ì—¬ì¡Œì„ ë•Œ
     */
    @StreamListener(KafkaProcessor.INPUT)
    public void whenOrderAccepted_then_UPDATE_2(@Payload OrderAccepted orderAccepted) {
        try {
            if (!orderAccepted.validate()) return;
                // view ê°ì²´ ì¡°íšŒ
            Optional<Mypage> mypageOptional = mypageRepository.findById(Long.valueOf(orderAccepted.getOrderId()));

            if( mypageOptional.isPresent()) {
                 Mypage mypage = mypageOptional.get();
            // view ê°ì²´ì— ì´ë²¤íŠ¸ì˜ eventDirectValue ë¥¼ set í•¨
                // view ë ˆíŒŒì§€ í† ë¦¬ì— save
                 mypageRepository.save(mypage);
                }


        }catch (Exception e){
            e.printStackTrace();
        }
    }

    /**
        ì£¼ë¬¸ì´ ê±°ì ˆë˜ì—ˆì„ ë•Œ
     */
    @StreamListener(KafkaProcessor.INPUT)
    public void whenOrderRejected_then_UPDATE_3(@Payload OrderRejected orderRejected) {
        try {
            if (!orderRejected.validate()) return;
                // view ê°ì²´ ì¡°íšŒ

                List<Mypage> mypageList = mypageRepository.findByStatus(orderRejected.getOrderId());
                for(Mypage mypage : mypageList){
                    // view ê°ì²´ì— ì´ë²¤íŠ¸ì˜ eventDirectValue ë¥¼ set í•¨
                    mypage.setStatus("rejected");
                // view ë ˆíŒŒì§€ í† ë¦¬ì— save
                mypageRepository.save(mypage);
                }

        }catch (Exception e){
            e.printStackTrace();
        }
    }
}
```


<br><br>

## ğŸˆ ì²´í¬í¬ì¸íŠ¸3 Compensation / Correlation

![image](https://user-images.githubusercontent.com/70236767/205807967-d25ec7f4-ec46-4ba0-8fd9-314aa8bb8e78.png)


ì£¼ë¬¸ì´ ì·¨ì†Œë  ë•Œ Compensationì´ ë°œìƒí•œë‹¤. Order í´ë˜ìŠ¤ì—ì„œ @PreRemove ì–´ë…¸í…Œì´ì…˜ì´ ì ìš©ëœ onPreRemove ë©”ì†Œë“œì—ì„œ êµ¬í˜„í•œë‹¤.

ì£¼ë¬¸ì·¨ì†Œ ì´ë²¤íŠ¸ OrderCanceledë¥¼ publishí•˜ë©´ì„œ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì¸ storeì—ì„œ updateStatus ì •ì±…ì„ í†µí•´ ìƒíƒœë¥¼ ë³€ê²½í•  ìˆ˜ ìˆë‹¤.

ì„œë¡œ ë‹¤ë¥¸ ë§ˆì´í¬ë¡œì„œë¹„ìŠ¤ ê°„ ë°ì´í„° ì¼ê´€ì„± ì²˜ë¦¬ë¥¼ ìœ„í•´ ì‚¬ìš©í•˜ëŠ” correlation keyì— ëŒ€í•´ ì£¼ë¬¸ì˜ ì•„ì´ë””ì¸ orderIdë¥¼ ì‚¬ìš©í•œë‹¤.


```java
    /**
        ì£¼ë¬¸ì´ ì·¨ì†Œë  ë•Œ ë³´ìƒ ì²˜ë¦¬
     */
    @PreRemove
    public void onPreRemove(){
        // ì£¼ë¬¸ ì·¨ì†Œ publish
        OrderCanceled orderCanceled = new OrderCanceled(this);
        orderCanceled.publishAfterCommit();
    }
```

<br><br>

## ğŸˆ ì²´í¬í¬ì¸íŠ¸4 Request / Response

![image](https://user-images.githubusercontent.com/70236767/205790898-e4a3aafc-f671-4478-946f-539551faa785.png)


coupon contextì—ì„œ ì¿ í°ì„ ì‚¬ìš©í•˜ë©´ req/resë¡œ ordering contextì— ì£¼ë¬¸ì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¿ í°ì„ ì£¼ë¬¸ì— ì ìš©ì‹œí‚¨ë‹¤.



### coupon context

![image](https://user-images.githubusercontent.com/70236767/205777473-681e3afa-2b26-4ae1-88b9-421d78a978cd.png)


Coupon.java

```java
    @PostPersist
    public void onPostPersist(){
        // CouponCreated couponCreated = new CouponCreated(this);
        // couponCreated.publishAfterCommit();

        // ì¿ í°ì„ ì‚¬ìš©í•œë‹¤ë©´ 
        if (isUsed == true) {

            // ordering contextì— ë™ê¸° í˜¸ì¶œ(req / res)

            //Following code causes dependency to external APIs
            // it is NOT A GOOD PRACTICE. instead, Event-Policy mapping is recommended.            
            mall.external.Order order = new mall.external.Order().;
            
            // ë™ê¸° í˜¸ì¶œ í•  ë•Œ couponì˜ idì™€ orderì˜ id ë‹´ì•„ ë³´ë‚´ê¸°
            order.setCouponId(this.getId()); // coupon id
            order.setOrderId(this.getOrderId()); // order id
            
            // mappings goes here
            CouponApplication.applicationContext.getBean(mall.external.OrderService.class)
                .updateCoupon(order);

            // couponUsed publish
            CouponUsed couponUsed = new CouponUsed(this);
            couponUsed.publishAfterCommit();
        }
    }
```

OrderService.java

```java
@FeignClient(name = "ordering", url = "${api.url.ordering}")
public interface OrderService {
    /**
        ì¿ í°ì„ ì‚¬ìš©í•  ë•Œ ì£¼ë¬¸ì— ë°˜ì˜í•˜ê¸° ìœ„í•´  ordering contextì— í˜¸ì¶œ
     */
    @RequestMapping(method= RequestMethod.PATCH, path="/orders/{id}/updatecoupon)
    public void updateCoupon(@RequestBody Order order);
}


```


### ordering context

OrderController

```java
    /**
        ì£¼ë¬¸ì— ì¿ í° ì ìš©
     */
    @RequestMapping(
        value = "orders/{id}/updatecoupon",
        method = RequestMethod.PUT,
        produces = "application/json;charset=UTF-8"
    )
    public Order updateCoupon(
        @PathVariable(value = "id") Long id,
        @RequestBody UpdateCouponCommand updateCouponCommand,
        HttpServletRequest request,
        HttpServletResponse response
    ) throws Exception {
        System.out.println("##### /order/updateCoupon  called #####");
        Optional<Order> optionalOrder = orderRepository.findById(id);

        optionalOrder.orElseThrow(() -> new Exception("No Entity Found"));
        Order order = optionalOrder.get();

        // ì£¼ë¬¸ì— ì¿ í° ì ìš©
        order.updateCoupon(updateCouponCommand);

        orderRepository.save(order);
        return order;
    }
```

<br><br>

## ğŸˆ ì²´í¬í¬ì¸íŠ¸5 Circuit Breaker

Spring FeignClient + Hystrixë¥¼ ì´ìš©í•˜ì—¬ êµ¬í˜„í•œë‹¤.

Request/Response í†µì‹  í•˜ëŠ” í”„ë¡œì íŠ¸ì˜ application.yml íŒŒì¼ì—ì„œ ë‹¤ìŒì˜ ì„¤ì •ì„ ì¶”ê°€ (ë³¸ ì‹¤ìŠµì—ì„œ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ default profileì— ì„¤ì • ì¶”ê°€)

```yml
feign:
  hystrix:
    enabled: true
    
hystrix:
  command:
    # ì „ì—­ì„¤ì •
    default:
      execution.isolation.thread.timeoutInMilliseconds: 610

```

ë³¸ ì„¤ê³„ì—ì„œëŠ” ì¿ í°ì„ ì ìš©í•  ë•Œ ì¿ í° ì»¨í…ìŠ¤íŠ¸ì™€ ì£¼ ì»¨í…ìŠ¤íŠ¸ ì‚¬ì´ì˜ ì—°ê²°ì„ RESTful Request/Response ë¡œ ì—°ë™í•˜ì—¬ êµ¬í˜„í–ˆë‹¤. 

ìš”ì²­ì´ ê³¼ë„í•  ê²½ìš° Circuit Breaker ë¥¼ í†µí•˜ì—¬ ì¥ì• ê²©ë¦¬í•œë‹¤.

Hystrix ì„¤ì •
```
execution.isolation.thread.timeoutInMilliseconds: 610
```

ìš”ì²­ì²˜ë¦¬ ì“°ë ˆë“œì—ì„œ ì²˜ë¦¬ì‹œê°„ì´ 610 ë°€ë¦¬ê°€ ë„˜ì–´ì„œê¸° ì‹œì‘í•˜ì—¬ ì–´ëŠì •ë„ ìœ ì§€ë˜ë©´ Circuit Breaker íšŒë¡œê°€ ë‹«íˆë„ë¡ (ìš”ì²­ì„ ë¹ ë¥´ê²Œ ì‹¤íŒ¨ì²˜ë¦¬, ì°¨ë‹¨) ì„¤ì •



<br><br>

## ğŸˆ ì²´í¬í¬ì¸íŠ¸6 Gateway / Ingress

### ë¡œì»¬ ì„¤ì •

contextë§ˆë‹¤ í¬íŠ¸ë²ˆí˜¸ë¥¼ ë‹¤ë¥´ê²Œ ì„¤ì •í•˜ì˜€ë‹¤.

```yml
spring:
  profiles: default
  cloud:
    gateway:
      routes:
        - id: ordering
          uri: http://localhost:8081
          predicates:
            - Path=/orders/**, /payments/**, 
        - id: store
          uri: http://localhost:8082
          predicates:
            - Path=/foodCookings/**, 
        - id: rider
          uri: http://localhost:8083
          predicates:
            - Path=/deliveries/**, 
        - id: customer
          uri: http://localhost:8084
          predicates:
            - Path=, /mypages/**
        - id: coupon
          uri: http://localhost:8085
          predicates:
            - Path=/coupons/**, 
        - id: frontend
          uri: http://localhost:8080
          predicates:
            - Path=/**
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins:
              - "*"
            allowedMethods:
              - "*"
            allowedHeaders:
              - "*"
            allowCredentials: true
```

### ë„ì»¤ ì„¤ì •

```yml
spring:
  profiles: docker
  cloud:
    gateway:
      routes:
        - id: ordering
          uri: http://ordering:8080
          predicates:
            - Path=/orders/**, /payments/**, 
        - id: store
          uri: http://store:8080
          predicates:
            - Path=/foodCookings/**, 
        - id: rider
          uri: http://rider:8080
          predicates:
            - Path=/deliveries/**, 
        - id: customer
          uri: http://customer:8080
          predicates:
            - Path=, /mypages/**
        - id: coupon
          uri: http://coupon:8080
          predicates:
            - Path=/coupons/**, 
        - id: frontend
          uri: http://frontend:8080
          predicates:
            - Path=/**
      globalcors:
        corsConfigurations:
          '[/**]':
            allowedOrigins:
              - "*"
            allowedMethods:
              - "*"
            allowedHeaders:
              - "*"
            allowCredentials: true
```

<br><br>

## Model
www.msaez.io/#/storming/fa783b1b90dfa0eb180753d693a78c47


<br><br>

<br><br>

# ì„œë²„ ì‹¤í–‰ README

## Before Running Services
### Make sure there is a Kafka server running
```
cd kafka
docker-compose up
```
- Check the Kafka messages:
```
cd kafka
docker-compose exec -it kafka /bin/bash
cd /bin
./kafka-console-consumer --bootstrap-server localhost:9092 --topic
```

## Run the backend micro-services
See the README.md files inside the each microservices directory:

- ordering
- store
- rider
- customer


## Run API Gateway (Spring Gateway)
```
cd gateway
mvn spring-boot:run
```

## Test by API
- ordering
```
 http :8088/orders id="id" productId="productId" options="options" addres="addres" customerId="customerId" storeId="storeId" 
 http :8088/payments id="id" orderId="orderId" status="status" 
```
- store
```
 http :8088/foodCookings id="id" status="status" foodId="foodId" orderId="orderId" options="options" storeId="storeId" 
```
- rider
```
 http :8088/deliveries id="id" status="status" orderId="orderId" address="address" 
```
- customer
```
```


## Run the frontend
```
cd frontend
npm i
npm run serve
```

## Test by UI
Open a browser to localhost:8088

## Required Utilities

- httpie (alternative for curl / POSTMAN) and network utils
```
sudo apt-get update
sudo apt-get install net-tools
sudo apt install iputils-ping
pip install httpie
```

- kubernetes utilities (kubectl)
```
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
sudo install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl
```

- aws cli (aws)
```
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
unzip awscliv2.zip
sudo ./aws/install
```

- eksctl 
```
curl --silent --location "https://github.com/weaveworks/eksctl/releases/latest/download/eksctl_$(uname -s)_amd64.tar.gz" | tar xz -C /tmp
sudo mv /tmp/eksctl /usr/local/bin
```

